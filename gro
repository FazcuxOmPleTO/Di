-- AUTO-FIRE COMPATÍVEL COM CABESA 2.2
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local VirtualUser = game:GetService("VirtualUser")

-- CONFIGURAÇÕES
local FirePositions = {
    Vector2.new(-0.707, -832),
    Vector2.new(-0.654, -246)
}
local centerTolerance = 11
local maxDistance = 300 -- studs

-- Função para detectar partes com face (mesma do CABESA)
local function hasFaceMarker(obj)
    if not obj then return false end
    if obj:FindFirstChild("face") then return true end
    for _,c in ipairs(obj:GetChildren()) do
        if c:IsA("Decal") or c:IsA("Texture") then
            return true
        end
    end
    return false
end

-- Função de raycast para linha de visão
local function canSeeTarget(targetPart)
    if not targetPart or not targetPart.Parent then return false end
    local origin = Camera.CFrame.Position
    local direction = (targetPart.Position - origin)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = { LocalPlayer.Character }
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

    local result = Workspace:Raycast(origin, direction, raycastParams)
    if result then
        return result.Instance:IsDescendantOf(targetPart.Parent)
    end
    return true
end

-- Checa se o alvo está no centro da tela
local function IsAtScreenCenter(screenPos)
    local screenCenter = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    return (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude <= centerTolerance
end

-- Scaner principal baseado no CABESA 2.2
RunService.RenderStepped:Connect(function()
    if not LocalPlayer or not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return
    end

    local hrpPos = LocalPlayer.Character.HumanoidRootPart.Position

    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") and hasFaceMarker(obj) then
            -- sobe até encontrar o Model com Humanoid
            local model = obj
            while model and not model:IsA("Model") do
                model = model.Parent
            end

            if model and model:FindFirstChildOfClass("Humanoid") then
                local player = Players:GetPlayerFromCharacter(model)
                if player and player ~= LocalPlayer then
                    -- evita FakeVisualCabesa
                    if obj.Name == "FakeVisualCabesa" then
                        continue
                    end

                    local humanoid = model:FindFirstChildOfClass("Humanoid")
                    if humanoid and humanoid.Health > 0 then
                        local distance = (hrpPos - obj.Position).Magnitude
                        if distance <= maxDistance then
                            local screenPos, onScreen = Camera:WorldToViewportPoint(obj.Position)
                            if onScreen and IsAtScreenCenter(screenPos) and canSeeTarget(obj) then
                                -- atira nas posições fornecidas
                                for _, pos in ipairs(FirePositions) do
                                    VirtualUser:CaptureController()
                                    VirtualUser:ClickButton1(Vector2.new(pos.X, pos.Y))
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end)
